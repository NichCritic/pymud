'''
Created on 2013-11-06

@author: Nich
'''

from parsimonious.grammar import Grammar
#from parsimonious.exceptions import ParseError
from parsimonious.nodes import NodeVisitor
import logging

#TODO: make grammar dynamic based on the objects in the room


#print(grammar.parse('((bold stuff))'))
"""
        command = (verb to_player text+) / (verb to_object text+) / (verb text+)
        verb = "say" / "go"
        to_player = signifier player
        to_object = signifier object
        text        = ~"[A-Z 0-9]*"i
        player = "julie" / "alex" / "alice" / "bob" / "judy" 
        object = "chair" / "couch" / "door"
        signifier = " to "
"""


def surround(surrounding_text, text):
    return surrounding_text+text+surrounding_text

def format_objects(object_name_list):
    return " / ".join([surround('"', text) for text in object_name_list])

def build_grammar(player_names, object_names):
    player_names_format = format_objects(player_names)
    object_names_format = format_objects(object_names)
    command_grammar = Grammar(
        """
        command = (verb to_player text+) / (verb to_object text+) / (verb text+)
        verb = "say" / "go"
        to_player = to player
        to_object = to object
        text        = ~"[A-Z 0-9]*"i
        player = {players}
        object = {objects}
        to = " to "
        """.format(players = player_names_format, objects = object_names_format))
    return command_grammar

class CommandTokenMatcher():
    def __init__(self, command_context = None):
        self.command_context = {}
    
    def match_command(self, command, command_context = None):
        command_grammar = build_grammar(["julie", "alex", "alice", "bob", "judy"], ["couch", "chair", "door"])
        ast = command_grammar.parse(command)
        #print(ast)
        mapping = CommandVisitor(command_context).visit(ast)
        
        
        
        return mapping


command_grammar = build_grammar(["julie", "alex", "alice", "bob", "judy"], ["couch", "chair", "door"])
command_grammar.parse("say to alice hello world")




class CommandVisitor(NodeVisitor):
    def __init__(self, command_context):
        self.command_context = command_context
        
    def visit_command(self, node, visited_children):
        #print("do visit command")
        flat_children = flatten(visited_children, ltypes = list)
        #print(flat_children)
        results = {}
        for ch in flat_children:
            if ch[0] in results:
                results[ch[0]] += ch[1]
            else:
                results[ch[0]] = ch[1]
        return results
    
    def visit_verb(self, node, visited_children):
        #print("do visit verb")
        return (node.expr_name, node.text)
    
    
    def visit_to_player(self, node, visited_children):
        to, player = visited_children
        player_object = self.command_context["players"][player[1]]
        
        return ("target", player_object)    
    
    def visit_to(self, node, visited_children):
        #print("do visit preposition")
        return (node.expr_name, node.text)
    
        
    def visit_player(self, node, visited_children):
        #print("do visit player")
        return (node.expr_name, node.text)
    
    def visit_object(self, node, visited_children):
        #print("do visit object")
        return (node.expr_name, node.text)
    
    
    def visit_text(self, node, visited_children):
        """Return the text verbatim."""
        #print("do visit text")
        return (node.expr_name, node.text)
    
    def generic_visit(self, node, visited_children):
        #print("do visit generic")
       # print(visited_children)
        
        return visited_children

    
    
def flatten(l, ltypes=(list, tuple)):
    ltype = type(l)
    l = list(l)
    i = 0
    while i < len(l):
        while isinstance(l[i], ltypes):
            if not l[i]:
                l.pop(i)
                i -= 1
                break
            else:
                l[i:i + 1] = l[i]
        i += 1
    return ltype(l)   
    
    
    
    
    
    
    
    
    
    
            
    
    
    
    